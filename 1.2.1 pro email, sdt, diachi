

-- lyquang
use db_assignment;
drop procedure ThemEmail;
describe nv_thuviec;

drop procedure if exists insert_into_nvemail;
DELIMITER $$
CREATE PROCEDURE insert_into_nvemail (
    IN p_maso_nv CHAR(9),
    IN p_email VARCHAR(40)
)
BEGIN
    DECLARE msg VARCHAR(255);
    -- Kiểm tra nếu nhân viên có tồn tại trong bảng nhan_vien
    IF p_email IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy thêm Email!';
	end if;
     IF p_maso_nv IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy nhập mã số nhân viên!';
	end if;
  IF NOT EXISTS (SELECT 1 FROM nhan_vien WHERE maso_nv = p_maso_nv) THEN
       SET msg = CONCAT('Không tồn tại nhân viên với mã số: ', p_maso_nv);
     SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = msg;
  END IF;
    -- Thêm email vào bảng nvEMAIL
    INSERT INTO nvEMAIL (maso_nv, email)
    VALUES (p_maso_nv, p_email);
END$$
DELIMITER ;

select * from nvemail; 
CALL Insert_into_nvemail('NV0000003', 'dellhieu@gmail.com');
call insert_into_nvemail(null,'@');
CALL ThemEmail('NV0000002', 'dellhieuna@example.com');
CALL ThemEmail('NV0000005', 'hieua@example.com');

drop procedure XoaEmail;

drop procedure if exists delete_nvemail;
DELIMITER $$
CREATE PROCEDURE delete_nvemail (
    IN p_maso_nv CHAR(9),
    IN p_email VARCHAR(40)
)
BEGIN
    DECLARE msg VARCHAR(255);
    IF p_email IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy thêm Email!';
	end if;
     IF p_maso_nv IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy nhập mã số nhân viên!';
	end if;
    -- Kiểm tra nếu email tồn tại
    IF NOT EXISTS (SELECT 1 FROM nvEMAIL WHERE maso_nv = p_maso_nv AND email = p_email) THEN
        SET msg = CONCAT('Không tồn tại email: ', p_email, ' cho nhân viên: ', p_maso_nv);
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = msg;
    END IF;

    -- Xóa email khỏi bảng nvEMAIL
    DELETE FROM nvEMAIL
    WHERE maso_nv = p_maso_nv AND email = p_email;
END$$
DELIMITER ;
SELECT* FROM NVEMAIL;
call delete_nvemail('NV0000001', 'OOKOKOKOKO@GMAIL.COM');

-- sửa email

drop procedure if exists UPDATE_NVEMAIL;
DELIMITER $$

CREATE PROCEDURE UPDATE_NVEMAIL (
    IN p_maso_nv CHAR(9),
    IN p_old_email VARCHAR(40),
    IN p_new_email VARCHAR(40)
)
BEGIN
    DECLARE msg VARCHAR(255);
     IF p_old_email IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy thêm Email cũ !';
	end if;
     IF p_new_email IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy thêm Email mới !';
	end if;
     IF p_maso_nv IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy nhập mã số nhân viên!';
	end if;
    -- Kiểm tra nếu email cũ tồn tại
    IF NOT EXISTS (SELECT 1 FROM nvEMAIL WHERE maso_nv = p_maso_nv AND email = p_old_email) THEN
        SET msg = CONCAT('Không tồn tại email: ', p_old_email, ' cho nhân viên: ', p_maso_nv);
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = msg;
    END IF;

    -- Sửa email
    UPDATE nvEMAIL
    SET email = p_new_email
    WHERE maso_nv = p_maso_nv AND email = p_old_email;
END$$
DELIMITER ;

SELECT * FROM NVEMAIL;
CALL UPDATE_NVEMAIL('NV0000002','dellhieuna@example.com','quang@gmail');

drop procedure them_sdt;

drop procedure if exists insert_into_nvsdt;
DELIMITER $$

CREATE PROCEDURE insert_into_nvsdt(
    IN p_maso_nv CHAR(9),
    IN p_sdt CHAR(10)
)
BEGIN
  DECLARE msg VARCHAR(255);
	IF p_sdt IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy thêm số điện thoại!';
	end if;
     IF p_maso_nv IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy nhập mã số nhân viên!';
	end if;
    -- Check if the phone number is valid (10 digits)
    IF p_sdt REGEXP '^[0-9]{10}$' THEN
        -- Check if the employee exists (referenced by maso_nv)
        IF EXISTS (SELECT 1 FROM nhan_vien WHERE maso_nv = p_maso_nv) THEN
            -- Insert the phone number into nvSDT table
            INSERT INTO nvSDT (maso_nv, sdt) VALUES (p_maso_nv, p_sdt);
        ELSE
          SET msg = CONCAT('Không tồn tại nhân viên với mã số: ', p_maso_nv );
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = msg ;
        END IF;
    ELSE
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Số diện thoại bạn nhập không đúng format, Số điện thoại cần 10 số';
    END IF;
END$$
DELIMITER ;

select * from nvsdt;
call insert_into_nvsdt('NV0000005', '00000000');


drop procedure if exists delete_nvsdt;
DELIMITER $$
CREATE PROCEDURE delete_nvsdt( IN p_maso_nv CHAR(9) , IN p_sdt CHAR(10))
BEGIN 
    DECLARE msg VARCHAR(255);
    IF p_sdt IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy thêm số điện thoại!';
	end if;
     IF p_maso_nv IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy nhập mã số nhân viên!';
	end if;
    -- kiem tra neu sdt ton tai
    IF not exists ( select 1 from nvsdt where maso_nv = p_maso_nv AND sdt = p_sdt) then
    set msg = CONCAT('Không tồn tại số điện thoại : ', p_sdt,'cho nhan vien' , p_maso_nv);
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = msg;
    END IF;
	DELETE FROM nvsdt
    where maso_nv= p_maso_nv and sdt = p_sdt;
    END$$
DELIMITER ;

select * from nvsdt;
call delete_nvsdt('NV0000002','0123456789');

drop procedure suasdt;
drop procedure if exists update_nvsdt;
DELIMITER $$
CREATE PROCEDURE update_nvsdt( 
						IN p_maso_nv CHAR(9), 
                        in p_old_sdt varchar(10),
                        in p_new_sdt varchar(10) 
)
begin
    declare msg varchar(255);
	IF p_old_sdt IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy thêm số điện thoại cũ !';
	end if;
    IF p_new_sdt IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy thêm số điện thoại mới !';
	end if;
     IF p_maso_nv IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hãy nhập mã số nhân viên!';
	end if;
	
    if not exists (select 1 from nvsdt where maso_nv = p_maso_nv AND sdt = p_old_sdt) then
    set msg = Concat('Không tồn tại số điện thoại : ', p_old_sdt, 'cho nhan vien' , p_maso_nv);
    signal sqlstate '45000' set message_text = msg;
end if;
	Update nvsdt
    set sdt = p_new_sdt
    where maso_nv = p_maso_nv AND sdt = p_old_sdt;
END$$
DELIMITER ;

select * from nvsdt;
call update_nvsdt('NV0000004','0000000000','1111111111');

DELIMITER $$
CREATE PROCEDURE Themdiachi(
    IN p_maso_nv CHAR(9),
    IN p_sonha VARCHAR(30),
    IN p_tenduong VARCHAR(30),
    IN p_phuong VARCHAR(30),
    IN p_tinh_thanhpho VARCHAR(30)
)
BEGIN
    -- Kiểm tra mã số nhân viên có tồn tại trong bảng nhan_vien
    IF EXISTS (SELECT 1 FROM nhan_vien WHERE maso_nv = p_maso_nv) THEN
        -- Thêm địa chỉ vào bảng nvDIACHI
        INSERT INTO nvDIACHI (maso_nv, sonha, tenduong, phuong, tinh_thanhpho)
        VALUES (p_maso_nv, p_sonha, p_tenduong, p_phuong, p_tinh_thanhpho);
    ELSE
        -- Báo lỗi nếu nhân viên không tồn tại
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Employee does not exist';
    END IF;
END$$

DELIMITER ;
SELECT * FROM NVDIACHI;
call Themdiachi('NV0000001','123','TAN DA','HUONG SO', 'THANH PHO HUE');
call Themdiachi('NV0000002','123','QUAN 5','HUONG SO', 'THANH PHO HUE');
call Themdiachi('NV0000005','123','QUAN DELL','HUONG SO', 'THANH PHO HUE');

DELIMITER $$
CREATE PROCEDURE XOADIACHI( IN p_maso_nv char(9), 
							in p_sonha varchar(30), 
                            in p_tenduong varchar(30),
                            in p_phuong varchar(30),
                            in p_tinh_thanhpho varchar(30)
)  
begin 
	if exists ( select 1 from nvdiachi
				where maso_nv = p_maso_nv
                and sonha = p_sonha
                and tenduong = p_tenduong
                and phuong = p_phuong
                and tinh_thanhpho = p_tinh_thanhpho 
                ) then
                delete from nvdiachi
                where maso_nv = p_maso_nv
                and sonha = p_sonha
                and tenduong = p_tenduong
                and phuong = p_phuong
                and tinh_thanhpho = p_tinh_thanhpho ;
		else
        signal sqlstate '45000' set Message_text='address not found';
        end if;
end$$
    
DELIMITER ;
select * from nvdiachi;
call Xoadiachi('NV0000005','1213','QUAN DELL','HUONG SO', 'THANH PHO HUE');

DELIMITER $$
CREATE PROCEDURE suadiachi( IN p_maso_nv char(9),
				 in p_old_sonha varchar(30),
                 in p_old_tenduong varchar(30),
                 in p_old_phuong varchar(30),
                 in p_old_tinh_thanhpho varchar(30),
                 in p_new_sonha varchar(30),
                 in p_new_tenduong varchar(30),
                 in p_new_phuong varchar(30),
                 in p_new_tinh_thanhpho varchar(30)
                 )
begin
  If exists ( select 1 from nvdiachi
			where maso = p_maso
             and sonha = p_sonha
			and tenduong = p_tenduong
			and phuong = p_phuong
			and tinh_thanhpho = p_tinh_thanhpho 
  ) then
			update nvdiachi
            set so_nha = p_new_sonha 
            and tenduong = p_new_tenduong 
            and phuong =  p_new_phuong
            and tinh_thanhpho = p_new_tinh_thanhpho 
		where  maso_nv = p_maso_nv
		and  sonha = p_old_sonha
			and tenduong = p_old_tenduong
			and phuong = p_old_phuong
			and tinh_thanhpho = p_old_tinh_thanhpho ;
		else signal sqlstate '45000' set Message_text = 'Địa chỉ cũ không tìm thấy';
        end if;
        end $$
DELIMITER ;

	


select * from nhan_vien;
Call Them_sdt('NV0000001', '0856141590');
select * from nvSDT;


 
